<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        .estado-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .pedido-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-clipboard-list"></i> Sistema de Pedidos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/pedidos">Pedidos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/calendario">Calendario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reportes">Reportes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Salir</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-box"></i> Gesti√≥n de Pedidos</h2>
            <button class="btn btn-primary" onclick="procesarEmails()">
                <i class="fas fa-sync"></i> Procesar Nuevos Emails
            </button>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> Filtros</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Mes</label>
                        <select id="filtroMes" class="form-select">
                            <option value="">Todos</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>A√±o</label>
                        <select id="filtroAnio" class="form-select">
                            <option value="">Todos</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Estado</label>
                        <select id="filtroEstado" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button class="btn btn-success w-100" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <table id="tablaPedidos" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>N¬∫ Pedido</th>
                            <th>Fecha Recepci√≥n</th>
                            <th>Fecha Entrega</th>
                            <th>Lugar</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaPedidos">
                        <!-- Los pedidos se cargan din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Pedido -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle del Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleContent">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let tablaPedidos;

        $(document).ready(function() {
            console.log('‚úÖ P√°gina de pedidos cargada, iniciando carga...');
            cargarPedidos();
        });

        function cargarPedidos() {
            console.log('üîÑ Solicitando pedidos a /api/pedidos...');
            $.get('/api/pedidos')
                .done(function(data) {
                    console.log('‚úÖ Pedidos recibidos:', data.length, 'pedidos');
                    console.log('Datos:', data);
                    mostrarPedidos(data);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('‚ùå Error al cargar pedidos:', textStatus, errorThrown);
                    console.error('Respuesta:', jqXHR.responseText);
                    alert('Error al cargar pedidos. Ver consola (F12) para m√°s detalles.');
                });
        }

        function mostrarPedidos(pedidos) {
            const tbody = $('#listaPedidos');
            tbody.empty();

            pedidos.forEach(pedido => {
                const estadoBadge = getEstadoBadge(pedido.estado);
                const row = `
                    <tr>
                        <td><strong>${pedido.numeroPedido}</strong></td>
                        <td>${formatearFecha(pedido.fechaRecepcion)}</td>
                        <td>${formatearFecha(pedido.fechaEntrega)}</td>
                        <td>${pedido.lugarEntrega || '-'}</td>
                        <td>$${pedido.total ? pedido.total.toFixed(2) : '0.00'}</td>
                        <td>${estadoBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verDetalle(${pedido.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="cambiarEstado(${pedido.id})">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            if (tablaPedidos) {
                tablaPedidos.destroy();
            }
            tablaPedidos = $('#tablaPedidos').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                },
                order: [[1, 'desc']]
            });
        }

        function getEstadoBadge(estado) {
            const colores = {
                'RECIBIDO': 'primary',
                'CALENDARIO_CREADO': 'info',
                'ENVIADO_PLANTA': 'warning',
                'EN_FABRICACION': 'secondary',
                'ENTREGADO': 'success',
                'COBRADO': 'success',
                'FINALIZADO': 'dark'
            };
            const color = colores[estado] || 'secondary';
            return `<span class="badge bg-${color}">${estado.replace(/_/g, ' ')}</span>`;
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const d = new Date(fecha);
            return d.toLocaleDateString('es-AR');
        }

        function procesarEmails() {
            if (!confirm('¬øDesea procesar los emails de pedidos ahora?')) {
                return;
            }

            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

            $.ajax({
                url: '/api/pedidos/procesar-emails',
                method: 'POST',
                success: function(response) {
                    alert('‚úì ' + response.message + '\n\nLos pedidos se actualizar√°n en breve.');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    // Recargar la tabla despu√©s de 3 segundos
                    setTimeout(cargarPedidos, 3000);
                },
                error: function(xhr) {
                    let errorMsg = 'Error al procesar emails';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert('‚úó ' + errorMsg);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            });
        }

        function verDetalle(id) {
            $.get(`/api/pedidos/${id}`, function(pedido) {
                let itemsHtml = '';
                pedido.items.forEach(item => {
                    itemsHtml += `
                        <tr>
                            <td>${item.producto}</td>
                            <td>${item.cantidad}</td>
                            <td>$${item.precioUnitario.toFixed(2)}</td>
                            <td>$${item.subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                });

                const html = `
                    <div class="pedido-card card">
                        <div class="card-body">
                            <h4>${pedido.numeroPedido}</h4>
                            <p><strong>Estado:</strong> ${getEstadoBadge(pedido.estado)}</p>
                            <p><strong>Fecha de Entrega:</strong> ${formatearFecha(pedido.fechaEntrega)}</p>
                            <p><strong>Lugar:</strong> ${pedido.lugarEntrega || '-'}</p>
                            <p><strong>Email Origen:</strong> ${pedido.emailOrigen || '-'}</p>

                            <h5 class="mt-3">Productos</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unit.</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3">Total</th>
                                        <th>$${pedido.total.toFixed(2)}</th>
                                    </tr>
                                    ${pedido.comision ? `
                                    <tr>
                                        <th colspan="3">Comisi√≥n (8%)</th>
                                        <th>$${pedido.comision.toFixed(2)}</th>
                                    </tr>
                                    ` : ''}
                                </tfoot>
                            </table>

                            ${pedido.turnoBlancaLuna ? `<p><strong>Turno BlancaLuna:</strong> ${pedido.turnoBlancaLuna}</p>` : ''}
                            ${pedido.notas ? `<p><strong>Notas:</strong> ${pedido.notas}</p>` : ''}
                        </div>
                    </div>
                `;

                $('#detalleContent').html(html);
                new bootstrap.Modal(document.getElementById('modalDetalle')).show();
            });
        }

        function cambiarEstado(id) {
            // Aqu√≠ podr√≠as implementar un modal para cambiar el estado
            alert('Funci√≥n para cambiar estado del pedido ' + id);
        }

        function aplicarFiltros() {
            const mes = $('#filtroMes').val();
            const anio = $('#filtroAnio').val();

            let url = '/api/pedidos';
            if (mes && anio) {
                url = `/api/pedidos/mes/${mes}/anio/${anio}`;
            } else if (anio) {
                url = `/api/pedidos/anio/${anio}`;
            }

            $.get(url, function(data) {
                mostrarPedidos(data);
            });
        }
    </script>
</body>
</html>

