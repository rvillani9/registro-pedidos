<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes y Estadísticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-clipboard-list"></i> Sistema de Pedidos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/pedidos">Pedidos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/calendario">Calendario</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reportes">Reportes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Salir</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h2>

        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Pedidos</h5>
                        <h2 id="totalPedidos" class="text-primary">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">En Proceso</h5>
                        <h2 id="enProceso" class="text-warning">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Entregados</h5>
                        <h2 id="entregados" class="text-success">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Monto Total</h5>
                        <h2 id="montoTotal" class="text-info">$0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Pedidos por Estado</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartEstados"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Ventas por Mes</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartVentas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-dollar-sign"></i> Reporte de Comisiones</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label>Seleccionar Año:</label>
                    <select id="anioReporte" class="form-select" onchange="cargarReporte()">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Pedidos</th>
                            <th>Total Ventas</th>
                            <th>Comisiones (8%)</th>
                        </tr>
                    </thead>
                    <tbody id="tablaComisiones">
                        <!-- Se carga dinámicamente -->
                    </tbody>
                    <tfoot>
                        <tr class="fw-bold">
                            <td>TOTAL</td>
                            <td id="totalPedidosAnio">0</td>
                            <td id="totalVentasAnio">$0</td>
                            <td id="totalComisionesAnio">$0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        $(document).ready(function() {
            cargarEstadisticas();
            cargarReporte();
        });

        function cargarEstadisticas() {
            $.get('/api/pedidos', function(pedidos) {
                // Estadísticas generales
                $('#totalPedidos').text(pedidos.length);

                const enProceso = pedidos.filter(p =>
                    !['ENTREGADO', 'COBRADO', 'FINALIZADO'].includes(p.estado)
                ).length;
                $('#enProceso').text(enProceso);

                const entregados = pedidos.filter(p =>
                    ['ENTREGADO', 'COBRADO', 'FINALIZADO'].includes(p.estado)
                ).length;
                $('#entregados').text(entregados);

                const montoTotal = pedidos.reduce((sum, p) => sum + (p.total || 0), 0);
                $('#montoTotal').text('$' + montoTotal.toFixed(2));

                // Gráfico de estados
                const estadosCount = {};
                pedidos.forEach(p => {
                    estadosCount[p.estado] = (estadosCount[p.estado] || 0) + 1;
                });

                new Chart(document.getElementById('chartEstados'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(estadosCount),
                        datasets: [{
                            data: Object.values(estadosCount),
                            backgroundColor: [
                                '#007bff', '#17a2b8', '#ffc107', '#6c757d',
                                '#28a745', '#dc3545', '#343a40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Gráfico de ventas por mes
                const ventasPorMes = {};
                for (let i = 1; i <= 12; i++) {
                    ventasPorMes[i] = 0;
                }

                pedidos.forEach(p => {
                    if (p.mesPedido) {
                        ventasPorMes[p.mesPedido] += (p.total || 0);
                    }
                });

                new Chart(document.getElementById('chartVentas'), {
                    type: 'bar',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Ventas ($)',
                            data: Object.values(ventasPorMes),
                            backgroundColor: '#007bff'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        function cargarReporte() {
            const anio = $('#anioReporte').val();
            $.get(`/api/pedidos/anio/${anio}`, function(pedidos) {
                const reportePorMes = {};

                for (let i = 1; i <= 12; i++) {
                    reportePorMes[i] = {
                        cantidad: 0,
                        total: 0,
                        comision: 0
                    };
                }

                pedidos.forEach(p => {
                    const mes = p.mesPedido;
                    if (mes) {
                        reportePorMes[mes].cantidad++;
                        reportePorMes[mes].total += (p.total || 0);
                        reportePorMes[mes].comision += (p.comision || 0);
                    }
                });

                let html = '';
                let totalPedidos = 0;
                let totalVentas = 0;
                let totalComisiones = 0;

                for (let i = 1; i <= 12; i++) {
                    const datos = reportePorMes[i];
                    totalPedidos += datos.cantidad;
                    totalVentas += datos.total;
                    totalComisiones += datos.comision;

                    html += `
                        <tr>
                            <td>${meses[i-1]}</td>
                            <td>${datos.cantidad}</td>
                            <td>$${datos.total.toFixed(2)}</td>
                            <td>$${datos.comision.toFixed(2)}</td>
                        </tr>
                    `;
                }

                $('#tablaComisiones').html(html);
                $('#totalPedidosAnio').text(totalPedidos);
                $('#totalVentasAnio').text('$' + totalVentas.toFixed(2));
                $('#totalComisionesAnio').text('$' + totalComisiones.toFixed(2));
            });
        }
    </script>
</body>
</html>

